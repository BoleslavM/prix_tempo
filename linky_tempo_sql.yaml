# ============================================================
# Capteurs SQL pour Coût Linky avec Tempo
# ============================================================
sql:
  # Énergie totale (vous l'avez déjà)
  - name: "linky_energie_totale"
    query: >
      SELECT ROUND(s.sum / 1000.0, 3) AS kwh
      FROM statistics s
      JOIN statistics_meta m ON m.id = s.metadata_id
      WHERE m.statistic_id = 'linky:xxx'
      ORDER BY s.start_ts DESC
      LIMIT 1;
    column: "kwh"
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing


  # Consommation du jour précédent (données reçues à 06:30)
  - name: "linky_conso_hier"
    query: >
      SELECT ROUND(SUM(s.state) / 1000.0, 3) AS kwh
      FROM statistics s
      JOIN statistics_meta m ON m.id = s.metadata_id
      WHERE m.statistic_id = 'linky:xxx'
        AND s.start_ts >= CAST(strftime('%s', datetime('now', '-1 day', 'start of day')) AS INTEGER)
        AND s.start_ts < CAST(strftime('%s', datetime('now', 'start of day')) AS INTEGER)
    column: "kwh"
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total
